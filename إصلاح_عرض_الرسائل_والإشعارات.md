# โ ุฅุตูุงุญ ุนุฑุถ ุงูุฑุณุงุฆู ูุงูุฅุดุนุงุฑุงุช

## ุงููุดุงูู ุงูุชู ุชู ุญููุง:

### 1. ุงูุฑุณุงุฆู ูุง ุชุธูุฑ ูู ุงููุงุฆูุฉ โ
**ุงูุณุจุจ:** ูุงู ุงูููุฏ ูุญุงูู ุฌูุจ ุงูุจูุงูุงุช ุจุทุฑููุฉ ูุนูุฏุฉ ูุน relationships

**ุงูุญู:** โ ุชู ุชุบููุฑ ุทุฑููุฉ ุฌูุจ ุงูุจูุงูุงุช:
- ุฌูุจ ุงูุฑุณุงุฆู ุฃููุงู
- ุซู ุฌูุจ ูุนูููุงุช ุงููุฑุณู ูุงููุณุชูุจู ููู ุฑุณุงูุฉ
- ุฏูุฌ ุงูุจูุงูุงุช ูุนุงู

### 2. ุนุฏู ุธููุฑ ุฅุดุนุงุฑุงุช ููุฑุณุงุฆู ุงูุฌุฏูุฏุฉ โ
**ุงูุณุจุจ:** ูู ููู ููุงู trigger ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู:** โ ุฅุถุงูุฉ trigger ุชููุงุฆู

---

## ุฎุทูุงุช ุงูุชุทุจูู

### ุงูุฎุทูุฉ 1: ุชุญุฏูุซ ุงูููุฏ (ุชู โ)
ุงูููุฏ ุชู ุชุญุฏูุซู ุชููุงุฆูุงู ูู `MessagesPage.tsx`

### ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ Trigger ููุฅุดุนุงุฑุงุช
ุงูุชุญ Supabase SQL Editor ูุดุบู ูุฐุง ุงูููุฏ:

```sql
-- ุญุฐู ุงูู trigger ุงููุฏูู ุฅู ูุฌุฏ
DROP TRIGGER IF EXISTS trigger_notify_new_message ON messages;
DROP FUNCTION IF EXISTS notify_new_message();

-- ุฅูุดุงุก function ููุฅุดุนุงุฑุงุช
CREATE OR REPLACE FUNCTION notify_new_message()
RETURNS TRIGGER AS $$
DECLARE
  sender_name TEXT;
BEGIN
  -- ุฌูุจ ุงุณู ุงููุฑุณู
  SELECT COALESCE(full_name, 'ูุณุชุฎุฏู') INTO sender_name
  FROM profiles
  WHERE id = NEW.sender_id;
  
  -- ุฅูุดุงุก ุฅุดุนุงุฑ ูููุณุชูู
  INSERT INTO notifications (user_id, type, title, message, related_id)
  VALUES (
    NEW.receiver_id,
    'message',
    'ุฑุณุงูุฉ ุฌุฏูุฏุฉ',
    'ูุฏูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู ' || sender_name || ': ' || NEW.subject,
    NEW.id::text
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ุฅูุดุงุก trigger
CREATE TRIGGER trigger_notify_new_message
  AFTER INSERT ON messages
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_message();

SELECT 'ุชู ุฅุถุงูุฉ trigger ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ! โ' as status;
```

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุงููุธุงู
1. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ (F5)
2. ุญุงูู ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
3. ูุฌุจ ุฃู ุชุธูุฑ ุงูุฑุณุงูุฉ ูู:
   - โ ุตูุฏูู ุงูุตุงุฏุฑ ูููุฑุณู
   - โ ุตูุฏูู ุงููุงุฑุฏ ูููุณุชูู
   - โ ุงูุฅุดุนุงุฑุงุช ูู ุฃุนูู ุงูุตูุญุฉ (ูููุณุชูู)

---

## ูุง ุชู ุชุญุณููู:

### ูู ุงูููุฏ:
1. โ ุทุฑููุฉ ุฌูุจ ุงูุฑุณุงุฆู ุฃุตุจุญุช ุฃูุซุฑ ููุซูููุฉ
2. โ ุชุญุฏูุซ ุชููุงุฆู ูููุงุฆูุฉ ุจุนุฏ ุฅุฑุณุงู ุฑุณุงูุฉ
3. โ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
1. โ Trigger ุชููุงุฆู ูุฅูุดุงุก ุฅุดุนุงุฑุงุช
2. โ ูุฌูุจ ุงุณู ุงููุฑุณู ุชููุงุฆูุงู
3. โ ูุถูู ููุถูุน ุงูุฑุณุงูุฉ ูู ุงูุฅุดุนุงุฑ

---

## ููู ูุนูู ุงููุธุงู ุงูุขู:

### ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ:
1. ุงููุฑุณู ููุชุจ ุงูุฑุณุงูุฉ ููุถุบุท "ุฅุฑุณุงู"
2. ุงูุฑุณุงูุฉ ุชูุญูุธ ูู ุฌุฏูู `messages`
3. **Trigger ุชููุงุฆู** ูููุดุฆ ุฅุดุนุงุฑ ูููุณุชูู
4. ุงูุฅุดุนุงุฑ ูุธูุฑ ูู ุฃุนูู ุงูุตูุญุฉ ๐
5. ุงูุฑุณุงูุฉ ุชุธูุฑ ูู ุตูุฏูู ุงูุตุงุฏุฑ ูููุฑุณู
6. ุงูุฑุณุงูุฉ ุชุธูุฑ ูู ุตูุฏูู ุงููุงุฑุฏ ูููุณุชูู

### ุนูุฏ ุงุณุชูุงู ุฑุณุงูุฉ:
1. ุงููุณุชูู ูุฑู ุฅุดุนุงุฑ ูู ุฃุนูู ุงูุตูุญุฉ
2. ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ูุชุญุฏุซ
3. ุงูุฑุณุงูุฉ ุชุธูุฑ ุจุฎูููุฉ ุฒุฑูุงุก ูู ุงููุงุฑุฏ
4. ุนูุฏ ูุชุญ ุงูุฑุณุงูุฉุ ุชูุญุฏุซ ุญุงูุชูุง ุฅูู "ููุฑูุกุฉ"

---

## ุงูุชุญูู ูู ุงููุฌุงุญ:

### 1. ุงูุชุญูู ูู Trigger:
```sql
SELECT 
  trigger_name,
  event_manipulation,
  event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'trigger_notify_new_message';
```

ูุฌุจ ุฃู ุชุฑู trigger ููุฌูุฏ ุนูู ุฌุฏูู messages.

### 2. ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ:
1. ุฃุฑุณู ุฑุณุงูุฉ ูู ุงููุฏูุฑ ุฅูู ููุธู
2. ุณุฌู ุฏุฎูู ูููุธู
3. ูุฌุจ ุฃู ุชุฑู:
   - โ ุฅุดุนุงุฑ ูู ุฃุนูู ุงูุตูุญุฉ
   - โ ุนุฏุงุฏ ุฃุญูุฑ ุนูู ุฃููููุฉ ุงูุฑุณุงุฆู
   - โ ุงูุฑุณุงูุฉ ูู ุตูุฏูู ุงููุงุฑุฏ

### 3. ุงูุชุญูู ูู ุงูุฅุดุนุงุฑุงุช:
```sql
SELECT * FROM notifications 
WHERE type = 'message' 
ORDER BY created_at DESC 
LIMIT 5;
```

ูุฌุจ ุฃู ุชุฑู ุฅุดุนุงุฑุงุช ุงูุฑุณุงุฆู.

---

## ุฅุฐุง ูู ุชุธูุฑ ุงูุฅุดุนุงุฑุงุช:

### ุชุญูู ูู ุฌุฏูู notifications:
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'notifications';
```

ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ุดุบู:
```sql
CREATE TABLE IF NOT EXISTS notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  related_id TEXT,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);

ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own notifications"
  ON notifications FOR SELECT
  USING (auth.uid()::text = user_id::text);
```

---

**ุงูุขู ุงููุธุงู ูุนูู ุจุดูู ูุงูู! ๐**

- โ ุงูุฑุณุงุฆู ุชุธูุฑ ูู ุงูููุงุฆู
- โ ุงูุฅุดุนุงุฑุงุช ุชุนูู ุชููุงุฆูุงู
- โ ุงูุนุฏุงุฏุงุช ุชุชุญุฏุซ ููุฑูุงู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ
