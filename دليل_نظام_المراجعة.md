# دليل نظام المراجعة والاعتماد

## نظرة عامة
تم إضافة نظام متكامل لمراجعة واعتماد المهام المكتملة، يتيح للمديرين والمراجعين مراجعة العمل المنجز قبل اعتماده نهائياً.

## المميزات الجديدة

### 1. حالة جديدة: "جاري المراجعة" (pending_review)
- عندما ينتهي الموظف من المهمة، يضغط على "إرسال للمراجعة"
- تنتقل المهمة تلقائياً إلى حالة "جاري المراجعة"
- يتم إرسال إشعار للمراجع المحدد
- **مهم**: يجب تعيين مراجع للمهمة أولاً، وإلا لن يظهر زر "إرسال للمراجعة"

### 2. تعيين المراجع
- **فقط المدير** يمكنه تعيين المراجع
- يتم تعيين المراجع عند إنشاء المهمة أو من صفحة تفاصيل المهمة
- المراجع يمكن أن يكون مدير أو موظف آخر
- الموظفون يمكنهم رؤية من هو المراجع لكن لا يمكنهم تغييره

### 3. صلاحيات تغيير الحالة إلى "جاري المراجعة"
**فقط شخصان يمكنهم تغيير الحالة يدوياً إلى "جاري المراجعة":**
- المدير
- المراجع المحدد للمهمة

**الموظف المنفذ:**
- لا يمكنه تغيير الحالة يدوياً
- يستخدم زر "إرسال للمراجعة" فقط (يظهر عند انتهاء العمل)

### 4. لوحة المراجعة
- صفحة جديدة في القائمة الجانبية: "لوحة المراجعة"
- تعرض جميع المهام المسندة للمراجع
- مقسمة إلى قسمين:
  - **مهام تحتاج للمراجعة**: المهام في حالة pending_review
  - **المهام المعتمدة**: المهام التي تم اعتمادها

### 5. إجراءات المراجع
المراجع لديه خيارين:
- **اعتماد**: تحويل المهمة إلى حالة "مكتملة" (done)
- **رد**: إعادة المهمة إلى "جاري العمل" (in_progress) للموظف

### 6. عرض المهام المكتملة
في صفحة "مهامي":
- المهام النشطة تظهر في الأعلى
- المهام المكتملة تظهر في الأسفل في قسم منفصل
- المهام المكتملة تظهر بخط طولي عليها وشفافية 60%

### 7. الإشعارات التلقائية
- عند إرسال مهمة للمراجعة → إشعار للمراجع
- عند رد المهمة → إشعار للموظف المنفذ

## سير العمل (Workflow)

```
1. المدير ينشئ مهمة ويعين:
   - موظف منفذ
   - مراجع (مهم!)
   ↓
2. الموظف يستلم المهمة (assigned)
   ↓
3. الموظف يبدأ العمل (in_progress)
   ↓
4. الموظف ينهي العمل ويضغط "إرسال للمراجعة"
   (الزر يظهر فقط إذا كان هناك مراجع محدد)
   ↓ (pending_review)
   ↓ إشعار للمراجع
5. المراجع يفتح لوحة المراجعة
   ↓
6a. المراجع يعتمد → (done) ✓
   أو
6b. المراجع يرد → (in_progress) ↻ إشعار للموظف
   ↓
7. الموظف يعيد العمل ويرسل للمراجعة مرة أخرى
```

## الصلاحيات

### المدير:
- ✅ إنشاء مهام
- ✅ تعيين موظف منفذ
- ✅ تعيين/تغيير المراجع
- ✅ تغيير حالة المهمة إلى "جاري المراجعة" يدوياً
- ✅ اعتماد أو رد المهام

### المراجع المحدد:
- ✅ تغيير حالة المهمة إلى "جاري المراجعة" يدوياً
- ✅ اعتماد المهام من لوحة المراجعة
- ✅ رد المهام للموظف المنفذ
- ❌ لا يمكنه تغيير المراجع

### الموظف المنفذ:
- ✅ استلام المهمة
- ✅ بدء العمل
- ✅ إرسال للمراجعة (عبر الزر فقط)
- ❌ لا يمكنه تغيير الحالة إلى "جاري المراجعة" يدوياً
- ❌ لا يمكنه رؤية أو تغيير المراجع

## الملفات المعدلة

### Migration
- `supabase/migrations/20240107_add_review_workflow.sql`
  - إضافة حقل `reviewer_id`
  - إضافة حقل `reviewed_at`
  - تحديث حالات المهام لإضافة `pending_review`
  - Triggers للإشعارات التلقائية

### Types
- `src/types/database.types.ts`
  - تحديث نوع `status` لإضافة `pending_review`
  - إضافة حقول `reviewer_id` و `reviewed_at`

### Components
- `src/components/ui/Badge.tsx`
  - إضافة لون وتسمية لحالة `pending_review`

### Pages
- `src/routes/TasksPage.tsx`
  - إضافة حقل المراجع في نموذج إنشاء المهمة
  - فصل المهام النشطة عن المكتملة
  - عرض المهام المكتملة بخط طولي
  - إضافة إحصائية "جاري المراجعة"

- `src/routes/ReviewPage.tsx` (جديد)
  - لوحة المراجعة الكاملة
  - عرض المهام المطلوب مراجعتها
  - أزرار الاعتماد والرد

- `src/routes/TaskDetailsPage.tsx`
  - إضافة حقل اختيار المراجع (للمدير فقط)
  - عرض المراجع للموظفين (للقراءة فقط)
  - تقييد تغيير الحالة إلى pending_review
  - تحديث قائمة الحالات

- `src/features/tasks/TaskCard.tsx`
  - تغيير زر "إنهاء" إلى "إرسال للمراجعة"
  - الزر يظهر فقط إذا كان هناك مراجع محدد
  - رسالة تنبيه إذا لم يكن هناك مراجع

### Routing
- `src/App.tsx`
  - إضافة route `/review`

- `src/components/Layout.tsx`
  - إضافة رابط "لوحة المراجعة" في القائمة الجانبية

### Hooks
- `src/features/tasks/useTasks.ts`
  - تحديث `updateTaskStatus` لدعم `pending_review`
  - تسجيل `completed_at` عند الإرسال للمراجعة
  - تسجيل `reviewed_at` عند الاعتماد

## كيفية الاستخدام

### للمدير:
1. عند إنشاء مهمة:
   - حدد الموظف المنفذ
   - **حدد المراجع (مهم جداً!)**
2. يمكنك تغيير المراجع لاحقاً من صفحة تفاصيل المهمة
3. يمكنك متابعة حالة المهمة من لوحة التحكم

### للموظف:
1. افتح صفحة "مهامي"
2. ابدأ العمل على المهمة (زر "بدء")
3. عند الانتهاء:
   - إذا كان هناك مراجع محدد: سيظهر زر "إرسال للمراجعة"
   - إذا لم يكن هناك مراجع: ستظهر رسالة "لا يوجد مراجع محدد"
4. اضغط "إرسال للمراجعة"
5. المهمة ستنتقل إلى قسم المهام المكتملة
6. إذا تم رد المهمة، ستظهر مرة أخرى مع إشعار

### للمراجع:
1. افتح "لوحة المراجعة" من القائمة الجانبية
2. ستجد المهام المطلوب مراجعتها
3. افتح تفاصيل المهمة للاطلاع عليها
4. اضغط "اعتماد" إذا كان العمل مقبول
5. اضغط "رد" إذا كان يحتاج تعديل (سيتم إرسال إشعار للموظف)

## تطبيق Migration

لتفعيل هذه الميزة، قم بتشغيل Migration في Supabase:

```sql
-- نسخ محتوى الملف:
supabase/migrations/20240107_add_review_workflow.sql

-- ولصقه في SQL Editor في Supabase Dashboard
-- ثم اضغط RUN
```

## ملاحظات مهمة

1. **المراجع إلزامي**: يجب تعيين مراجع لكي يظهر زر "إرسال للمراجعة"
2. **الإشعارات التلقائية**: تعمل فقط إذا كان المراجع محدد
3. **التوافق**: النظام متوافق مع جميع المهام الموجودة
4. **الصلاحيات**: فقط المدير يمكنه تعيين المراجع
5. **تغيير الحالة**: فقط المدير والمراجع يمكنهم تغيير الحالة إلى "جاري المراجعة" يدوياً

## الإحصائيات

تم تحديث الإحصائيات في:
- صفحة "مهامي": 4 بطاقات (مستلمة، جاري العمل، جاري المراجعة، مكتملة)
- لوحة المراجعة: 2 بطاقات (جاري المراجعة، معتمدة)

## استكشاف الأخطاء

### المشكلة: لا يظهر زر "إرسال للمراجعة"
**الحل**: تأكد من أن المدير قام بتعيين مراجع للمهمة

### المشكلة: المهمة لا تظهر في لوحة المراجعة
**الحل**: تأكد من:
1. تم تعيين المراجع للمهمة
2. حالة المهمة هي "pending_review"
3. أنت تسجل الدخول بحساب المراجع المحدد

### المشكلة: لا يمكن تغيير الحالة إلى "جاري المراجعة"
**الحل**: هذه الحالة محمية، فقط المدير أو المراجع المحدد يمكنهم تغييرها يدوياً

## الخطوات التالية (اختياري)

يمكن تطوير النظام بإضافة:
- تعليقات المراجع عند رد المهمة
- سجل المراجعات (كم مرة تم رد المهمة)
- تقييم جودة العمل
- تقارير أداء المراجعة

## الملفات المعدلة

### Migration
- `supabase/migrations/20240107_add_review_workflow.sql`
  - إضافة حقل `reviewer_id`
  - إضافة حقل `reviewed_at`
  - تحديث حالات المهام لإضافة `pending_review`
  - Triggers للإشعارات التلقائية

### Types
- `src/types/database.types.ts`
  - تحديث نوع `status` لإضافة `pending_review`
  - إضافة حقول `reviewer_id` و `reviewed_at`

### Components
- `src/components/ui/Badge.tsx`
  - إضافة لون وتسمية لحالة `pending_review`

### Pages
- `src/routes/TasksPage.tsx`
  - فصل المهام النشطة عن المكتملة
  - عرض المهام المكتملة بخط طولي
  - إضافة إحصائية "جاري المراجعة"

- `src/routes/ReviewPage.tsx` (جديد)
  - لوحة المراجعة الكاملة
  - عرض المهام المطلوب مراجعتها
  - أزرار الاعتماد والرد

- `src/routes/TaskDetailsPage.tsx`
  - إضافة حقل اختيار المراجع
  - تحديث قائمة الحالات لإضافة pending_review

- `src/features/tasks/TaskCard.tsx`
  - تغيير زر "إنهاء" إلى "إرسال للمراجعة"

### Routing
- `src/App.tsx`
  - إضافة route `/review`

- `src/components/Layout.tsx`
  - إضافة رابط "لوحة المراجعة" في القائمة الجانبية

### Hooks
- `src/features/tasks/useTasks.ts`
  - تحديث `updateTaskStatus` لدعم `pending_review`
  - تسجيل `completed_at` عند الإرسال للمراجعة
  - تسجيل `reviewed_at` عند الاعتماد

## كيفية الاستخدام

### للمدير:
1. عند إنشاء مهمة، قم بتعيين الموظف المنفذ
2. افتح تفاصيل المهمة وحدد المراجع من القائمة المنسدلة
3. يمكنك متابعة حالة المهمة من لوحة التحكم

### للموظف:
1. افتح صفحة "مهامي"
2. ابدأ العمل على المهمة (زر "بدء")
3. عند الانتهاء، اضغط "إرسال للمراجعة"
4. المهمة ستختفي من قائمة المهام النشطة
5. إذا تم رد المهمة، ستظهر مرة أخرى مع إشعار

### للمراجع:
1. افتح "لوحة المراجعة" من القائمة الجانبية
2. ستجد المهام المطلوب مراجعتها
3. افتح تفاصيل المهمة للاطلاع عليها
4. اضغط "اعتماد" إذا كان العمل مقبول
5. اضغط "رد" إذا كان يحتاج تعديل (سيتم إرسال إشعار للموظف)

## تطبيق Migration

لتفعيل هذه الميزة، قم بتشغيل Migration في Supabase:

```sql
-- نسخ محتوى الملف:
supabase/migrations/20240107_add_review_workflow.sql

-- ولصقه في SQL Editor في Supabase Dashboard
-- ثم اضغط RUN
```

## ملاحظات مهمة

1. **المراجع اختياري**: يمكن ترك حقل المراجع فارغاً، لكن لن يتم إرسال إشعارات
2. **الإشعارات التلقائية**: تعمل فقط إذا كان المراجع محدد
3. **التوافق**: النظام متوافق مع جميع المهام الموجودة
4. **الصلاحيات**: أي شخص يمكن أن يكون مراجع (مدير أو موظف)

## الإحصائيات

تم تحديث الإحصائيات في:
- صفحة "مهامي": 4 بطاقات (مستلمة، جاري العمل، جاري المراجعة، مكتملة)
- لوحة المراجعة: 2 بطاقات (جاري المراجعة، معتمدة)

## الخطوات التالية (اختياري)

يمكن تطوير النظام بإضافة:
- تعليقات المراجع عند رد المهمة
- سجل المراجعات (كم مرة تم رد المهمة)
- تقييم جودة العمل
- تقارير أداء المراجعة
