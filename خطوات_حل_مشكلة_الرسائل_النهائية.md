# ๐ง ุญู ููุงุฆู ููุดููุฉ ุงูุฑุณุงุฆู

## ุงููุดููุฉ
ุฑุณุงูุฉ ุงูุฎุทุฃ: "ุฌุฏูู ุงูุฑุณุงุฆู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"

ูุฐุง ูุนูู ุฃู ุงูุฌุฏูู ูู ูููุดุฃ ุจูุฌุงุญ ูู Supabase.

---

## ุงูุญู (ุฎุทูุฉ ุจุฎุทูุฉ)

### ุงูุฎุทูุฉ 1: ุชุดุฎูุต ุงููุดููุฉ
ุงูุชุญ Supabase SQL Editor ูุดุบู ูุฐุง ุงูุฃูุฑ:

```sql
SELECT 
  CASE 
    WHEN EXISTS (
      SELECT FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = 'messages'
    ) 
    THEN 'ุฌุฏูู messages ููุฌูุฏ โ'
    ELSE 'ุฌุฏูู messages ุบูุฑ ููุฌูุฏ โ'
  END as status;
```

**ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ "ุบูุฑ ููุฌูุฏ"ุ ุงูุชูู ููุฎุทูุฉ 2.**

---

### ุงูุฎุทูุฉ 2: ุญุฐู ุงูุฌุฏูู ุงููุฏูู (ุฅู ูุฌุฏ)
```sql
DROP TABLE IF EXISTS messages CASCADE;
```

---

### ุงูุฎุทูุฉ 3: ุฅูุดุงุก ุงูุฌุฏูู (ูุณุฎุฉ ูุจุณุทุฉ)
ุงูุณุฎ ูุงูุตู ูุฐุง ุงูููุฏ **ุจุงููุงูู**:

```sql
-- ุฅูุดุงุก ุงูุฌุฏูู
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sender_id UUID NOT NULL,
  receiver_id UUID NOT NULL,
  subject TEXT NOT NULL,
  body TEXT NOT NULL,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  read_at TIMESTAMPTZ
);

-- ุฅูุดุงุก ุงูููุงุฑุณ
CREATE INDEX idx_messages_sender ON messages(sender_id);
CREATE INDEX idx_messages_receiver ON messages(receiver_id);
CREATE INDEX idx_messages_created_at ON messages(created_at DESC);

-- ุชูุนูู RLS
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- ุงูุณูุงุณุงุช
CREATE POLICY "Users can view their own messages"
  ON messages FOR SELECT
  USING (
    auth.uid()::text = sender_id::text OR 
    auth.uid()::text = receiver_id::text
  );

CREATE POLICY "Users can send messages"
  ON messages FOR INSERT
  WITH CHECK (auth.uid()::text = sender_id::text);

CREATE POLICY "Receivers can mark messages as read"
  ON messages FOR UPDATE
  USING (auth.uid()::text = receiver_id::text);

CREATE POLICY "Users can delete their messages"
  ON messages FOR DELETE
  USING (
    auth.uid()::text = sender_id::text OR 
    auth.uid()::text = receiver_id::text
  );

SELECT 'ุชู ุฅูุดุงุก ุฌุฏูู ุงูุฑุณุงุฆู ุจูุฌุงุญ! โ' as status;
```

---

### ุงูุฎุทูุฉ 4: ุงูุชุญูู ูู ุงููุฌุงุญ
ุดุบู ูุฐุง ุงูุฃูุฑ:

```sql
SELECT COUNT(*) as total FROM messages;
```

**ูุฌุจ ุฃู ูุนูู ุจุฏูู ุฃุฎุทุงุก** (ุงููุชูุฌุฉ ุณุชููู 0 ูุฃูู ูุง ุชูุฌุฏ ุฑุณุงุฆู ุจุนุฏ).

---

### ุงูุฎุทูุฉ 5: ุงุฎุชุจุงุฑ ุงูุฅุฑุณุงู
ุงุฑุฌุน ููุชุทุจูู ูุญุงูู ุฅุฑุณุงู ุฑุณุงูุฉ ูุฑุฉ ุฃุฎุฑู.

---

## ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุงูุญู ุงูุจุฏูู: ุชุนุทูู RLS ูุคูุชุงู
ุฅุฐุง ุงุณุชูุฑ ุงูุฎุทุฃุ ุฌุฑุจ ุชุนุทูู RLS ููุงุฎุชุจุงุฑ:

```sql
ALTER TABLE messages DISABLE ROW LEVEL SECURITY;
```

โ๏ธ **ุชุญุฐูุฑ:** ูุฐุง ููุงุฎุชุจุงุฑ ููุท! ุฃุนุฏ ุชูุนูู RLS ุจุนุฏ ุงูุชุฃูุฏ ูู ุนูู ุงููุธุงู:

```sql
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
```

---

### ุงูุญู ุงูุจุฏูู 2: ุงุณุชุฎุฏุงู UUID ูู TEXT
ุฅุฐุง ูุงูุช ุงููุดููุฉ ูู ููุงุฑูุฉ UUID:

```sql
-- ุญุฐู ุงูุณูุงุณุงุช ุงููุฏููุฉ
DROP POLICY IF EXISTS "Users can view their own messages" ON messages;
DROP POLICY IF EXISTS "Users can send messages" ON messages;
DROP POLICY IF EXISTS "Receivers can mark messages as read" ON messages;
DROP POLICY IF EXISTS "Users can delete their messages" ON messages;

-- ุฅุนุงุฏุฉ ุฅูุดุงุก ุงูุณูุงุณุงุช ูุน ุชุญููู UUID ุฅูู TEXT
CREATE POLICY "Users can view their own messages"
  ON messages FOR SELECT
  USING (
    auth.uid()::text = sender_id::text OR 
    auth.uid()::text = receiver_id::text
  );

CREATE POLICY "Users can send messages"
  ON messages FOR INSERT
  WITH CHECK (auth.uid()::text = sender_id::text);

CREATE POLICY "Receivers can mark messages as read"
  ON messages FOR UPDATE
  USING (auth.uid()::text = receiver_id::text);

CREATE POLICY "Users can delete their messages"
  ON messages FOR DELETE
  USING (
    auth.uid()::text = sender_id::text OR 
    auth.uid()::text = receiver_id::text
  );
```

---

## ุงูุชุญูู ุงูููุงุฆู

ุจุนุฏ ุชุทุจูู ุงูุญูุ ุดุบู ูุฐู ุงูุฃูุงูุฑ ููุชุญูู:

```sql
-- 1. ุงูุชุญูู ูู ุงูุฌุฏูู
SELECT table_name FROM information_schema.tables WHERE table_name = 'messages';

-- 2. ุงูุชุญูู ูู ุงูุฃุนูุฏุฉ
SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'messages';

-- 3. ุงูุชุญูู ูู ุงูุณูุงุณุงุช
SELECT policyname FROM pg_policies WHERE tablename = 'messages';

-- 4. ุงูุชุญูู ูู RLS
SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'messages';
```

---

## ูููุงุช ูุณุงุนุฏุฉ

- `create_messages_simple.sql` - ูุณุฎุฉ ูุจุณุทุฉ ุจุฏูู trigger
- `ุชุดุฎูุต_ูุดููุฉ_ุงูุฑุณุงุฆู.sql` - ุฃูุงูุฑ ุชุดุฎูุต ุดุงููุฉ

---

**ุจุนุฏ ุชุทุจูู ูุฐู ุงูุฎุทูุงุชุ ูุฌุจ ุฃู ูุนูู ุงููุธุงู ุจูุฌุงุญ! ๐**

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ุฃุฑุณู ูู:
1. ูุชูุฌุฉ ุฃูุฑ ุงูุชุดุฎูุต ูู ุงูุฎุทูุฉ 1
2. ุฃู ุฑุณุงูุฉ ุฎุทุฃ ุชุธูุฑ ูู SQL Editor
3. ููุทุฉ ุดุงุดุฉ ูู Console ูู ุงููุชุตูุญ
