# โ ุฅุฎูุงุก ุงูุฅุดุนุงุฑ ุนูุฏ ูุฑุงุกุฉ ุงูุฑุณุงูุฉ

## ุงูููุฒุฉ ุงูุฌุฏูุฏุฉ
ุนูุฏ ูุชุญ ููุฑุงุกุฉ ุฑุณุงูุฉุ ูุฎุชูู ุงูุฅุดุนุงุฑ ุงููุฑุชุจุท ุจูุง ุชููุงุฆูุงู ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช.

---

## ููู ูุนูู ุงููุธุงู ุงูุขู:

### ุงูุณููุงุฑูู ุงููุงูู:

1. **ุฅุฑุณุงู ุฑุณุงูุฉ:**
   - ุงููุฑุณู ููุชุจ ุฑุณุงูุฉ ููุฑุณููุง
   - ุงูุฑุณุงูุฉ ุชูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - **Trigger ุชููุงุฆู** ููุดุฆ ุฅุดุนุงุฑ ูููุณุชูู
   - ุงูุฅุดุนุงุฑ ูุธูุฑ ูู ุงูุฌุฑุณ ๐

2. **ุงุณุชูุงู ุงูุฅุดุนุงุฑ:**
   - ุงููุณุชูู ูุฑู ุนุฏุงุฏ ุฃุญูุฑ ุนูู ุงูุฌุฑุณ
   - ููุชุญ ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
   - ูุฑู "ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู [ุงุณู ุงููุฑุณู]: [ุงูููุถูุน]"

3. **ูุฑุงุกุฉ ุงูุฑุณุงูุฉ:**
   - ุงููุณุชูู ูุถุบุท ุนูู ุงูุฅุดุนุงุฑ ุฃู ููุชุญ ุงูุฑุณุงูุฉ
   - ุงูุฑุณุงูุฉ ุชูุญุฏุซ ุญุงูุชูุง ุฅูู "ููุฑูุกุฉ"
   - **ุงูุฅุดุนุงุฑ ููุญุฏุซ ุชููุงุฆูุงู ุฅูู "ููุฑูุก"**
   - ุงูุฅุดุนุงุฑ ูุฎุชูู ูู ูุงุฆูุฉ ุบูุฑ ุงูููุฑูุกุฉ
   - ุงูุนุฏุงุฏ ุงูุฃุญูุฑ ูููุต

---

## ุงูุชุญุฏูุซุงุช ุงููุทุจูุฉ:

### 1. ูู ุงูููุฏ (ุชู โ):
- ุนูุฏ ูุฑุงุกุฉ ุฑุณุงูุฉุ ูุชู ุชุญุฏูุซ ุงูุฅุดุนุงุฑ ุงููุฑุชุจุท ุจูุง
- ุงูุฅุดุนุงุฑ ููุฑุจุท ุจุงูุฑุณุงูุฉ ุนุจุฑ ุฑุงุจุท ูุฑูุฏ
- ุฏุนู ูุชุญ ุงูุฑุณุงูุฉ ูุจุงุดุฑุฉ ูู ุงูุฅุดุนุงุฑ

### 2. ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุญุชุงุฌ ุชุทุจูู):
- Trigger ุฌุฏูุฏ ูุฑุจุท ุงูุฅุดุนุงุฑ ุจุงูุฑุณุงูุฉ
- Trigger ุขุฎุฑ ูุญุฏูุซ ุงูุฅุดุนุงุฑ ุนูุฏ ูุฑุงุกุฉ ุงูุฑุณุงูุฉ

---

## ุฎุทูุงุช ุงูุชุทุจูู:

### ุงูุชุญ Supabase SQL Editor ูุดุบู ูุฐุง ุงูููุฏ:

```sql
-- ุญุฐู ุงูู triggers ุงููุฏููุฉ
DROP TRIGGER IF EXISTS trigger_notify_new_message ON messages;
DROP FUNCTION IF EXISTS notify_new_message();
DROP TRIGGER IF EXISTS trigger_mark_notification_read ON messages;
DROP FUNCTION IF EXISTS mark_notification_read();

-- ุฅูุดุงุก function ูุฅูุดุงุก ุงูุฅุดุนุงุฑ
CREATE OR REPLACE FUNCTION notify_new_message()
RETURNS TRIGGER AS $$
DECLARE
  sender_name TEXT;
BEGIN
  SELECT COALESCE(full_name, 'ูุณุชุฎุฏู') INTO sender_name
  FROM profiles
  WHERE id = NEW.sender_id;
  
  INSERT INTO notifications (user_id, type, title, content, link, read)
  VALUES (
    NEW.receiver_id,
    'message',
    'ุฑุณุงูุฉ ุฌุฏูุฏุฉ',
    'ูุฏูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู ' || sender_name || ': ' || NEW.subject,
    '/messages?msg=' || NEW.id::text,
    false
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_notify_new_message
  AFTER INSERT ON messages
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_message();

-- ุฅูุดุงุก function ูุชุญุฏูุซ ุงูุฅุดุนุงุฑ ุนูุฏ ูุฑุงุกุฉ ุงูุฑุณุงูุฉ
CREATE OR REPLACE FUNCTION mark_notification_read()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_read = true AND OLD.is_read = false THEN
    UPDATE notifications
    SET read = true
    WHERE link = '/messages?msg=' || NEW.id::text
      AND user_id = NEW.receiver_id
      AND type = 'message';
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_mark_notification_read
  AFTER UPDATE ON messages
  FOR EACH ROW
  WHEN (NEW.is_read = true AND OLD.is_read = false)
  EXECUTE FUNCTION mark_notification_read();

SELECT 'ุชู ุชุญุฏูุซ triggers ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ! โ' as status;
```

---

## ุงูุงุฎุชุจุงุฑ:

### 1. ุฃุฑุณู ุฑุณุงูุฉ ุฌุฏูุฏุฉ:
- ูู ุงููุฏูุฑ ุฅูู ููุธู
- ูุฌุจ ุฃู ูุธูุฑ ุฅุดุนุงุฑ ููููุธู

### 2. ุงูุชุญ ุงูุฅุดุนุงุฑ:
- ุณุฌู ุฏุฎูู ูููุธู
- ุงูุชุญ ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
- ุงุถุบุท ุนูู ุฅุดุนุงุฑ ุงูุฑุณุงูุฉ
- ูุฌุจ ุฃู:
  - โ ุชูุชุญ ุตูุญุฉ ุงูุฑุณุงุฆู
  - โ ุชุธูุฑ ุงูุฑุณุงูุฉ ููุชูุญุฉ
  - โ ุงูุฅุดุนุงุฑ ูุฎุชูู ูู ุงููุงุฆูุฉ
  - โ ุงูุนุฏุงุฏ ุงูุฃุญูุฑ ูููุต

### 3. ุฃู ุงูุชุญ ุงูุฑุณุงูุฉ ูุจุงุดุฑุฉ:
- ุงุฐูุจ ูุตูุญุฉ ุงูุฑุณุงุฆู
- ุงูุชุญ ุงูุฑุณุงูุฉ ูู ุตูุฏูู ุงููุงุฑุฏ
- ูุฌุจ ุฃู:
  - โ ุงูุฅุดุนุงุฑ ูุฎุชูู ุชููุงุฆูุงู
  - โ ุงูุนุฏุงุฏ ุงูุฃุญูุฑ ูููุต

---

## ุงููููุฒุงุช:

### 1. ุฑุจุท ุฐูู:
- ูู ุฅุดุนุงุฑ ูุฑุชุจุท ุจุฑุณุงูุฉ ูุญุฏุฏุฉ
- ุนูุฏ ูุฑุงุกุฉ ุงูุฑุณุงูุฉุ ุงูุฅุดุนุงุฑ ููุญุฏุซ ุชููุงุฆูุงู

### 2. ุทุฑู ูุชุนุฏุฏุฉ:
- ุงูุถุบุท ุนูู ุงูุฅุดุนุงุฑ โ ููุชุญ ุงูุฑุณุงูุฉ
- ูุชุญ ุงูุฑุณุงูุฉ ูุจุงุดุฑุฉ โ ูุญุฏูุซ ุงูุฅุดุนุงุฑ
- ููุงููุง ูุนูู ุจููุณ ุงูุทุฑููุฉ

### 3. ุชุญุฏูุซ ููุฑู:
- ูุง ุญุงุฌุฉ ูุชุญุฏูุซ ุงูุตูุญุฉ
- Real-time updates
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ

---

## ุงูุชุญูู ูู ุงููุฌุงุญ:

### ุชุญูู ูู ุงูู triggers:
```sql
SELECT 
  trigger_name,
  event_manipulation,
  event_object_table
FROM information_schema.triggers
WHERE trigger_name IN ('trigger_notify_new_message', 'trigger_mark_notification_read')
ORDER BY trigger_name;
```

ูุฌุจ ุฃู ุชุฑู trigger-ูู:
1. `trigger_notify_new_message` - ุนูุฏ INSERT
2. `trigger_mark_notification_read` - ุนูุฏ UPDATE

### ุงุฎุชุจุงุฑ ุนููู:
```sql
-- ุฃุฑุณู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ
INSERT INTO messages (sender_id, receiver_id, subject, body)
VALUES (
  'SENDER_ID',
  'RECEIVER_ID',
  'ุฑุณุงูุฉ ุงุฎุชุจุงุฑ',
  'ูุฐู ุฑุณุงูุฉ ููุงุฎุชุจุงุฑ'
);

-- ุชุญูู ูู ุงูุฅุดุนุงุฑ
SELECT * FROM notifications 
WHERE type = 'message' 
ORDER BY created_at DESC 
LIMIT 1;

-- ุญุฏูุซ ุงูุฑุณุงูุฉ ูุชุตุจุญ ููุฑูุกุฉ
UPDATE messages 
SET is_read = true 
WHERE id = 'MESSAGE_ID';

-- ุชุญูู ูู ุชุญุฏูุซ ุงูุฅุดุนุงุฑ
SELECT * FROM notifications 
WHERE type = 'message' 
ORDER BY created_at DESC 
LIMIT 1;
-- ูุฌุจ ุฃู ูููู read = true
```

---

## ููุงุญุธุงุช ูููุฉ:

1. โ ุงูุฅุดุนุงุฑ ูุง ููุญุฐูุ ุจู ููุญุฏุฏ ูููุฑูุก
2. โ ูููู ุฑุคูุฉ ุงูุฅุดุนุงุฑุงุช ุงูููุฑูุกุฉ ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
3. โ ุงูุนุฏุงุฏ ุงูุฃุญูุฑ ูุนุฑุถ ููุท ุงูุฅุดุนุงุฑุงุช ุบูุฑ ุงูููุฑูุกุฉ
4. โ ูููู ุญุฐู ุงูุฅุดุนุงุฑ ูุฏููุงู ุฅุฐุง ุฃุฑุฏุช

---

**ุงูุขู ุงููุธุงู ูุนูู ุจุฐูุงุก! ุนูุฏ ูุฑุงุกุฉ ุงูุฑุณุงูุฉุ ุงูุฅุดุนุงุฑ ูุฎุชูู ุชููุงุฆูุงู! ๐**
