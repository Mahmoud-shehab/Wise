# خطوات تفعيل نظام المراجعة والاعتماد

## الخطوة 1: تطبيق Migration في Supabase

1. افتح Supabase Dashboard
2. اذهب إلى SQL Editor
3. انسخ محتوى الملف: `supabase/migrations/20240107_add_review_workflow.sql`
4. الصق المحتوى في SQL Editor
5. اضغط **RUN**

## الخطوة 2: التحقق من نجاح Migration

بعد تشغيل Migration، تحقق من:
- ✅ تم إضافة عمود `reviewer_id` في جدول `tasks`
- ✅ تم إضافة عمود `reviewed_at` في جدول `tasks`
- ✅ تم تحديث قيود الحالة لإضافة `pending_review`
- ✅ تم إنشاء Trigger للإشعارات

## الخطوة 3: استخدام النظام

### للمدير:
1. افتح أي مهمة
2. في قسم "معلومات المهمة"، ستجد حقل "المراجع"
3. اختر المراجع من القائمة المنسدلة
4. سيتم حفظ المراجع تلقائياً

### للموظف:
1. افتح صفحة "مهامي"
2. عند الانتهاء من مهمة، اضغط **"إرسال للمراجعة"**
3. ستنتقل المهمة إلى قسم "المهام المكتملة" في الأسفل
4. سيتم إرسال إشعار للمراجع تلقائياً

### للمراجع:
1. افتح **"لوحة المراجعة"** من القائمة الجانبية
2. ستجد المهام المطلوب مراجعتها
3. لكل مهمة، لديك خيارين:
   - **اعتماد**: المهمة مكتملة بنجاح ✓
   - **رد**: إعادة المهمة للموظف لإعادة العمل عليها ↻

## المميزات الجديدة

### 1. حالة جديدة: "جاري المراجعة"
- تظهر بلون بنفسجي
- تعني أن المهمة منتهية وتنتظر المراجعة

### 2. لوحة المراجعة
- صفحة جديدة في القائمة الجانبية
- تعرض جميع المهام المسندة لك كمراجع
- مقسمة إلى: "جاري المراجعة" و "معتمدة"

### 3. عرض المهام المكتملة
- في صفحة "مهامي"، المهام المكتملة تظهر في الأسفل
- عليها خط طولي وشفافية للتمييز

### 4. الإشعارات التلقائية
- عند إرسال مهمة للمراجعة → إشعار للمراجع
- عند رد المهمة → إشعار للموظف

## سير العمل الكامل

```
مدير ينشئ مهمة
    ↓
يعين موظف منفذ + مراجع
    ↓
موظف يستلم المهمة
    ↓
موظف يبدأ العمل
    ↓
موظف ينهي ويضغط "إرسال للمراجعة"
    ↓
إشعار للمراجع
    ↓
مراجع يفتح لوحة المراجعة
    ↓
مراجع يعتمد ✓  أو  يرد ↻
    ↓
إذا رد: إشعار للموظف + المهمة ترجع "جاري العمل"
```

## الإحصائيات الجديدة

### في صفحة "مهامي":
- مستلمة
- جاري العمل
- **جاري المراجعة** (جديد)
- مكتملة

### في لوحة المراجعة:
- جاري المراجعة
- معتمدة

## ملاحظات

- ✅ النظام متوافق مع جميع المهام الموجودة
- ✅ المراجع اختياري (يمكن تركه فارغ)
- ✅ أي شخص يمكن أن يكون مراجع (مدير أو موظف)
- ✅ الإشعارات تعمل تلقائياً عبر Database Triggers

## في حالة وجود مشاكل

إذا لم يعمل النظام:
1. تأكد من تشغيل Migration بنجاح
2. تحقق من وجود أخطاء في Console
3. تأكد من تحديث الصفحة بعد Migration
4. راجع ملف `دليل_نظام_المراجعة.md` للتفاصيل الكاملة
