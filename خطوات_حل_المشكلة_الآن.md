# ุฎุทูุงุช ุญู ูุดููุฉ ููุญุฉ ุงููุฑุงุฌุนุฉ - ุงูุขู!

## ุงููุดููุฉ
ุงููููุฉ ูุง ุชุธูุฑ ูู ููุญุฉ ุงููุฑุงุฌุนุฉ

## ุงูุณุจุจ
**ูู ูุชู ุชุทุจูู Migration ูู Supabase!**

## ุงูุญู (3 ุฎุทูุงุช ููุท)

### โก ุงูุฎุทูุฉ 1: ุชุทุจูู Migration

1. ุงูุชุญ **Supabase Dashboard**
2. ุงุฐูุจ ุฅูู **SQL Editor** (ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ)
3. ุงูุณุฎ ุงูููุฏ ุงูุชุงูู ุจุงููุงูู:

```sql
-- ุฅุถุงูุฉ ุญูู ุงููุฑุงุฌุน ูุญุงูุฉ ุงููุฑุงุฌุนุฉ
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS reviewer_id UUID REFERENCES profiles(id);
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS reviewed_at TIMESTAMPTZ;

-- ุชุญุฏูุซ ููุน ุงูุญุงูุฉ ูุฅุถุงูุฉ pending_review
ALTER TABLE tasks DROP CONSTRAINT IF EXISTS tasks_status_check;
ALTER TABLE tasks ADD CONSTRAINT tasks_status_check 
  CHECK (status IN ('backlog', 'assigned', 'in_progress', 'pending_review', 'done', 'blocked'));

-- Trigger ูุฅุฑุณุงู ุงููููุฉ ูููุฑุงุฌุน ุชููุงุฆูุงู ุนูุฏ ุชุญุฏูุฏ ุงูุญุงูุฉ ูู pending_review
CREATE OR REPLACE FUNCTION notify_reviewer_on_task_completion()
RETURNS TRIGGER AS $$
BEGIN
  -- ุฅุฐุง ุชู ุชุบููุฑ ุงูุญุงูุฉ ุฅูู pending_review ูููุงู ูุฑุงุฌุน
  IF NEW.status = 'pending_review' AND NEW.reviewer_id IS NOT NULL THEN
    INSERT INTO notifications (user_id, type, title, content, link)
    VALUES (
      NEW.reviewer_id,
      'task_review',
      'ูููุฉ ุฌุงูุฒุฉ ูููุฑุงุฌุนุฉ',
      'ุงููููุฉ "' || NEW.title || '" ุฌุงูุฒุฉ ูููุฑุงุฌุนุฉ',
      '/tasks/' || NEW.id
    );
  END IF;
  
  -- ุฅุฐุง ุชู ุฑุฏ ุงููููุฉ (ูู pending_review ุฅูู in_progress)
  IF OLD.status = 'pending_review' AND NEW.status = 'in_progress' AND NEW.assignee_id IS NOT NULL THEN
    INSERT INTO notifications (user_id, type, title, content, link)
    VALUES (
      NEW.assignee_id,
      'task_returned',
      'ุชู ุฑุฏ ุงููููุฉ',
      'ุชู ุฑุฏ ุงููููุฉ "' || NEW.title || '" ูุฅุนุงุฏุฉ ุงูุนูู ุนูููุง',
      '/tasks/' || NEW.id
    );
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_notify_reviewer ON tasks;
CREATE TRIGGER trigger_notify_reviewer
  AFTER UPDATE ON tasks
  FOR EACH ROW
  EXECUTE FUNCTION notify_reviewer_on_task_completion();

-- ุฅุถุงูุฉ ููุฑุณ ูููุฑุงุฌุน
CREATE INDEX IF NOT EXISTS idx_tasks_reviewer_id ON tasks(reviewer_id);
```

4. ุงูุตู ุงูููุฏ ูู SQL Editor
5. ุงุถุบุท **RUN** ุฃู **Ctrl+Enter**
6. ูุฌุจ ุฃู ุชุฑู ุฑุณุงูุฉ "Success" โ

### โก ุงูุฎุทูุฉ 2: ุฅุนุงุฏุฉ ุชุนููู ุงููุฑุงุฌุน

1. ุงุฑุฌุน ููุชุทุจูู
2. ุงูุชุญ ุงููููุฉ ูู ุตูุญุฉ ุชูุงุตูู ุงููููุฉ
3. ุงุฎุชุฑ ุงููุฑุงุฌุน (bahaa) ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
4. ุณูุชู ุญูุธู ุชููุงุฆูุงู

### โก ุงูุฎุทูุฉ 3: ุงูุชุญูู

1. ุณุฌู ุงูุฏุฎูู ุจุญุณุงุจ ุงููุฑุงุฌุน (bahaa)
2. ุงูุชุญ "ููุญุฉ ุงููุฑุงุฌุนุฉ" ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
3. ูุฌุจ ุฃู ุชุธูุฑ ุงููููุฉ ูู ูุณู "ููุฏ ุงูุชูููุฐ" โ

## ุงูุชุญูู ูู ูุฌุงุญ Migration

ุดุบูู ูุฐุง ุงูุงุณุชุนูุงู ูู SQL Editor:

```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'tasks' 
AND column_name IN ('reviewer_id', 'reviewed_at');
```

ูุฌุจ ุฃู ูุธูุฑ:
```
column_name  | data_type
reviewer_id  | uuid
reviewed_at  | timestamp with time zone
```

## ููุงุญุธุงุช

- โ Migration ุขูู ุชูุงูุงู (ูุณุชุฎุฏู `IF NOT EXISTS`)
- โ ูู ูุคุซุฑ ุนูู ุงูููุงู ุงูููุฌูุฏุฉ
- โ ูููู ุชุดุบููู ุฃูุซุฑ ูู ูุฑุฉ ุจุฏูู ูุดุงูู
- โ ุจุนุฏ Migrationุ ูู ุดูุก ุณูุนูู ุชููุงุฆูุงู

## ุฅุฐุง ูุงุฌูุช ูุดุงูู

ุงูุชุญ Developer Tools (F12) ูู ุงููุชุตูุญ ูุงูุธุฑ ุฅูู Console:
- ูุฌุจ ุฃู ุชุฑู: `๐ Fetching review tasks for user: ...`
- ูุฌุจ ุฃู ุชุฑู: `๐ Review tasks data: [...]`

ุฅุฐุง ูุงู `data` ูุงุฑุบุ ุชุฃูุฏ ูู:
1. ุชู ุชุทุจูู Migration ุจูุฌุงุญ
2. ุชู ุฅุนุงุฏุฉ ุชุนููู ุงููุฑุงุฌุน ูููููุฉ
3. ุฃูุช ูุณุฌู ุฏุฎูู ุจุญุณุงุจ ุงููุฑุงุฌุน ุงูุตุญูุญ

---

**ุจุนุฏ ูุฐู ุงูุฎุทูุงุชุ ูู ุดูุก ุณูุนูู! ๐**
