# โ ุญู ูุดููุฉ "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุฑุณุงูุฉ"

## ุงููุดููุฉ
ุงูุฎุทุฃ ุงูุฐู ุธูุฑ: **"Failed to load resource: the server responded with a status of 400"**

ูุฐุง ูุนูู ุฃู ุฌุฏูู `messages` ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

---

## ุงูุญู (ุฎุทูุฉ ูุงุญุฏุฉ ููุท!)

### 1. ุงูุชุญ Supabase SQL Editor
- ุงุฐูุจ ุฅูู https://supabase.com
- ุงูุชุญ ูุดุฑูุนู
- ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ: **SQL Editor**

### 2. ุงูุณุฎ ูุงูุตู ูุฐุง ุงูููุฏ ุจุงููุงูู:

```sql
-- ุฅูุดุงุก ุฌุฏูู ุงูุฑุณุงุฆู
CREATE TABLE IF NOT EXISTS messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sender_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  receiver_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  subject TEXT NOT NULL,
  body TEXT NOT NULL,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  read_at TIMESTAMPTZ,
  CONSTRAINT messages_sender_receiver_check CHECK (sender_id != receiver_id)
);

CREATE INDEX IF NOT EXISTS idx_messages_sender ON messages(sender_id);
CREATE INDEX IF NOT EXISTS idx_messages_receiver ON messages(receiver_id);
CREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_messages_is_read ON messages(is_read);

ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view their own messages" ON messages;
DROP POLICY IF EXISTS "Users can send messages" ON messages;
DROP POLICY IF EXISTS "Receivers can mark messages as read" ON messages;
DROP POLICY IF EXISTS "Users can delete their messages" ON messages;

CREATE POLICY "Users can view their own messages"
  ON messages FOR SELECT
  USING (auth.uid() = sender_id OR auth.uid() = receiver_id);

CREATE POLICY "Users can send messages"
  ON messages FOR INSERT
  WITH CHECK (auth.uid() = sender_id);

CREATE POLICY "Receivers can mark messages as read"
  ON messages FOR UPDATE
  USING (auth.uid() = receiver_id)
  WITH CHECK (auth.uid() = receiver_id);

CREATE POLICY "Users can delete their messages"
  ON messages FOR DELETE
  USING (auth.uid() = sender_id OR auth.uid() = receiver_id);

DROP TRIGGER IF EXISTS trigger_notify_new_message ON messages;
DROP FUNCTION IF EXISTS notify_new_message();

CREATE OR REPLACE FUNCTION notify_new_message()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO notifications (user_id, type, title, message, related_id)
  VALUES (
    NEW.receiver_id,
    'message',
    'ุฑุณุงูุฉ ุฌุฏูุฏุฉ',
    'ูุฏูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู ' || COALESCE((SELECT full_name FROM profiles WHERE id = NEW.sender_id), 'ูุณุชุฎุฏู'),
    NEW.id::text
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_notify_new_message
  AFTER INSERT ON messages
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_message();

SELECT 'ุชู ุฅูุดุงุก ุฌุฏูู ุงูุฑุณุงุฆู ุจูุฌุงุญ! โ' as message;
```

### 3. ุดุบู ุงูููุฏ
- ุงุถุบุท **Run** ุฃู **Ctrl+Enter**
- ุงูุชุธุฑ ุญุชู ุชุธูุฑ ุฑุณุงูุฉ ุงููุฌุงุญ

### 4. ุฌุฑุจ ุฅุฑุณุงู ุฑุณุงูุฉ ูุฑุฉ ุฃุฎุฑู
ุงุฑุฌุน ููุชุทุจูู ูุญุงูู ุฅุฑุณุงู ุฑุณุงูุฉ - ูุฌุจ ุฃู ุชุนูู ุงูุขู! โ

---

## ูุง ุชู ุฅุตูุงุญู ูู ุงูููุฏ

### 1. ุฑุณุงุฆู ุฎุทุฃ ุฃูุถู
ุงูุขู ุนูุฏ ุญุฏูุซ ุฎุทุฃุ ุณูุธูุฑ ูู ุฑุณุงูุฉ ูุงุถุญุฉ ุชุฎุจุฑู ุจุงููุดููุฉ:
- โ๏ธ "ุฌุฏูู ุงูุฑุณุงุฆู ุบูุฑ ููุฌูุฏ" - ุฅุฐุง ูู ุชุทุจู SQL
- โ๏ธ "ูุง ุชูุฌุฏ ุตูุงุญูุงุช ูุงููุฉ" - ุฅุฐุง ูุงูุช ูุดููุฉ RLS
- โ ุฑุณุงูุฉ ุงูุฎุทุฃ ุงููุนููุฉ - ูุฃู ุฎุทุฃ ุขุฎุฑ

### 2. ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
ุงูููุฏ ุงูุขู ูุชุนุงูู ูุน ุฌููุน ุฃููุงุน ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ.

---

## ุงูุชุญูู ูู ุงููุฌุงุญ

ุจุนุฏ ุชุทุจูู SQLุ ุดุบู ูุฐุง ุงูุฃูุฑ ููุชุญูู:

```sql
SELECT COUNT(*) as total_messages FROM messages;
```

ูุฌุจ ุฃู ูุนูู ุจุฏูู ุฃุฎุทุงุก (ุญุชู ูู ูุงู ุงูุนุฏุฏ 0).

---

## ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุฎุทุฃ "permission denied":
```sql
-- ุชุฃูุฏ ูู ุชูุนูู RLS
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
```

### ุฎุทุฃ "foreign key violation":
ุชุฃูุฏ ูู ูุฌูุฏ ุฌุฏูู `profiles` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ููุงุฎุชุจุงุฑ ุงูุณุฑูุน ููุท (ุชุนุทูู RLS ูุคูุชุงู):
```sql
ALTER TABLE messages DISABLE ROW LEVEL SECURITY;
```
โ๏ธ **ูุง ุชุณุชุฎุฏู ูุฐุง ูู ุงูุฅูุชุงุฌ!**

---

**ุงูุขู ุงููุธุงู ุฌุงูุฒ ููุนูู! ๐**
