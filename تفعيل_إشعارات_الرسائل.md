# ๐ ุชูุนูู ุฅุดุนุงุฑุงุช ุงูุฑุณุงุฆู

## ุงููุดููุฉ
ุฅุดุนุงุฑุงุช ุงูุฑุณุงุฆู ูุง ุชุธูุฑ ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช (ุงูุฌุฑุณ ๐) ูู ุฃุนูู ุงูุตูุญุฉ.

## ุงูุณุจุจ
ูู ูุชู ุชุทุจูู ุงูู trigger ุงูุฐู ููุดุฆ ุงูุฅุดุนุงุฑุงุช ุชููุงุฆูุงู ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ.

---

## ุงูุญู (ุฎุทูุฉ ูุงุญุฏุฉ!)

### ุงูุชุญ Supabase SQL Editor ูุดุบู ูุฐุง ุงูููุฏ:

```sql
-- ุญุฐู ุงูู trigger ุงููุฏูู ุฅู ูุฌุฏ
DROP TRIGGER IF EXISTS trigger_notify_new_message ON messages;
DROP FUNCTION IF EXISTS notify_new_message();

-- ุฅูุดุงุก function ููุฅุดุนุงุฑุงุช
CREATE OR REPLACE FUNCTION notify_new_message()
RETURNS TRIGGER AS $$
DECLARE
  sender_name TEXT;
BEGIN
  -- ุฌูุจ ุงุณู ุงููุฑุณู
  SELECT COALESCE(full_name, 'ูุณุชุฎุฏู') INTO sender_name
  FROM profiles
  WHERE id = NEW.sender_id;
  
  -- ุฅูุดุงุก ุฅุดุนุงุฑ ูููุณุชูู
  INSERT INTO notifications (user_id, type, title, content, link, read)
  VALUES (
    NEW.receiver_id,
    'message',
    'ุฑุณุงูุฉ ุฌุฏูุฏุฉ',
    'ูุฏูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู ' || sender_name || ': ' || NEW.subject,
    '/messages',
    false
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ุฅูุดุงุก trigger
CREATE TRIGGER trigger_notify_new_message
  AFTER INSERT ON messages
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_message();

SELECT 'ุชู ุฅุถุงูุฉ trigger ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ! โ' as status;
```

---

## ููู ูุนูู:

### ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ:
1. ุงูุฑุณุงูุฉ ุชูุญูุธ ูู ุฌุฏูู `messages`
2. **Trigger ุชููุงุฆู** ูุนูู ููุฑุงู
3. ูุฌูุจ ุงุณู ุงููุฑุณู ูู ุฌุฏูู `profiles`
4. ููุดุฆ ุฅุดุนุงุฑ ูู ุฌุฏูู `notifications` ูููุณุชูู
5. ุงูุฅุดุนุงุฑ ูุธูุฑ ูู ุงูุฌุฑุณ ๐ ูู ุฃุนูู ุงูุตูุญุฉ

### ูุญุชูู ุงูุฅุดุนุงุฑ:
- **ุงูุนููุงู:** "ุฑุณุงูุฉ ุฌุฏูุฏุฉ"
- **ุงููุญุชูู:** "ูุฏูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ูู [ุงุณู ุงููุฑุณู]: [ููุถูุน ุงูุฑุณุงูุฉ]"
- **ุงูุฑุงุจุท:** `/messages` (ุนูุฏ ุงูุถุบุท ููุชุญ ุตูุญุฉ ุงูุฑุณุงุฆู)

---

## ุงูุงุฎุชุจุงุฑ:

### 1. ุจุนุฏ ุชุทุจูู ุงูู SQL:
- ุฃุฑุณู ุฑุณุงูุฉ ูู ุงููุฏูุฑ ุฅูู ููุธู
- ุณุฌู ุฏุฎูู ูููุธู
- ูุฌุจ ุฃู ุชุฑู:
  - โ ุฅุดุนุงุฑ ูู ุงูุฌุฑุณ ๐
  - โ ุนุฏุงุฏ ุฃุญูุฑ ุนูู ุงูุฌุฑุณ
  - โ ุนุฏุงุฏ ุฃุญูุฑ ุนูู ุฃููููุฉ ุงูุฑุณุงุฆู ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ

### 2. ุนูุฏ ุงูุถุบุท ุนูู ุงูุฅุดุนุงุฑ:
- ููุชูู ุชููุงุฆูุงู ูุตูุญุฉ ุงูุฑุณุงุฆู
- ุงูุฅุดุนุงุฑ ููุญุฏุฏ ูููุฑูุก
- ุงูุฑุณุงูุฉ ุชุธูุฑ ูู ุตูุฏูู ุงููุงุฑุฏ

---

## ุงูุชุญูู ูู ุงููุฌุงุญ:

### ุชุญูู ูู ูุฌูุฏ ุงูู trigger:
```sql
SELECT 
  trigger_name,
  event_manipulation,
  event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'trigger_notify_new_message';
```

ูุฌุจ ุฃู ุชุฑู:
- trigger_name: `trigger_notify_new_message`
- event_manipulation: `INSERT`
- event_object_table: `messages`

### ุชุญูู ูู ุงูุฅุดุนุงุฑุงุช:
```sql
SELECT 
  id,
  type,
  title,
  content,
  link,
  read,
  created_at
FROM notifications
WHERE type = 'message'
ORDER BY created_at DESC
LIMIT 5;
```

ูุฌุจ ุฃู ุชุฑู ุฅุดุนุงุฑุงุช ุงูุฑุณุงุฆู.

---

## ุฅุฐุง ูู ุชุธูุฑ ุงูุฅุดุนุงุฑุงุช:

### 1. ุชุญูู ูู ุฌุฏูู notifications:
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'notifications';
```

### 2. ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ุฃูุดุฆู:
```sql
CREATE TABLE IF NOT EXISTS notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  content TEXT,
  link TEXT,
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);

ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own notifications"
  ON notifications FOR SELECT
  USING (auth.uid()::text = user_id::text);

CREATE POLICY "Users can update their own notifications"
  ON notifications FOR UPDATE
  USING (auth.uid()::text = user_id::text);

CREATE POLICY "Users can delete their own notifications"
  ON notifications FOR DELETE
  USING (auth.uid()::text = user_id::text);
```

### 3. ุชุญูู ูู ุฃุนูุฏุฉ ุงูุฌุฏูู:
```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'notifications'
ORDER BY ordinal_position;
```

ูุฌุจ ุฃู ุชุฑู ุงูุฃุนูุฏุฉ:
- id
- user_id
- type
- title
- content (ููู!)
- link (ููู!)
- read
- created_at

---

## ููุงุญุธุงุช ูููุฉ:

1. โ ุงูู trigger ูุนูู ุชููุงุฆูุงู - ูุง ุญุงุฌุฉ ูุฃู ููุฏ ุฅุถุงูู
2. โ ุงูุฅุดุนุงุฑุงุช ุชุธูุฑ ููุฑุงู ุจุฏูู ุชุญุฏูุซ ุงูุตูุญุฉ (Real-time)
3. โ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฅุดุนุงุฑุ ููุชูู ูุตูุญุฉ ุงูุฑุณุงุฆู
4. โ ุงูุฅุดุนุงุฑ ููุญุฏุฏ ูููุฑูุก ุชููุงุฆูุงู ุนูุฏ ุงูุถุบุท ุนููู

---

**ุจุนุฏ ุชุทุจูู ูุฐุง ุงูู SQLุ ุณุชุนูู ุงูุฅุดุนุงุฑุงุช ุจุดูู ูุงูู! ๐**
